<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrare PostƒÉri Facebook</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f6f8fa;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    #search {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    #info {
      margin-bottom: 15px;
      color: #666;
      font-size: 14px;
    }
    .post {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    button {
      background: #0366d6;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    button:hover {
      background: #0253b3;
    }
  </style>
</head>
<body>
  <h1>üìã PostƒÉri salvate din Facebook</h1>
  <input id="search" type="text" placeholder="üîç CautƒÉ √Æn text, autor sau link...">
  <div id="info">Se √ÆncarcƒÉ postƒÉrile...</div>
  <button id="deleteDupes" style="display:none;">üóëÔ∏è »òterge dublurile din Algolia</button>
  <div id="posts"></div>

  <script>
    let allPosts = [];
    let duplicates = [];

    async function loadPosts() {
      const info = document.getElementById("info");
      const container = document.getElementById("posts");

      try {
        const response = await fetch("https://propr.ro/.netlify/functions/index");
        if (!response.ok) throw new Error("Eroare HTTP " + response.status);

        const rawPosts = await response.json();
        const { uniquePosts, dupes } = detectDuplicates(rawPosts);

        allPosts = uniquePosts;
        duplicates = dupes;

        document.getElementById("deleteDupes").style.display = dupes.length ? "inline-block" : "none";
        info.textContent = `Afi»ôate ${uniquePosts.length} postƒÉri (din ${rawPosts.length}, ${dupes.length} duplicate detectate).`;
        renderPosts(uniquePosts);
      } catch (err) {
        info.innerHTML = `<span style="color:red;">Eroare: ${err.message}</span>`;
        console.error("Eroare la fetch:", err);
      }
    }

    // üîπ DetecteazƒÉ »ôi separƒÉ duplicatele
    function detectDuplicates(posts) {
      const seen = new Map();
      const uniquePosts = [];
      const dupes = [];

      for (const p of posts) {
        const key =
          (p.url && p.url.trim()) ||
          (p.text && p.text.substring(0, 100).trim().toLowerCase());
        if (!key) continue;

        if (!seen.has(key)) {
          seen.set(key, p.objectID || p.id);
          uniquePosts.push(p);
        } else {
          dupes.push(p);
        }
      }
      return { uniquePosts, dupes };
    }

    async function deleteDuplicates() {
      if (!duplicates.length) return alert("Nu existƒÉ duplicate de »ôters.");
      if (!confirm(`E»ôti sigur cƒÉ vrei sƒÉ »ôtergi ${duplicates.length} postƒÉri duplicate din Algolia?`)) return;

      try {
        const ids = duplicates.map(d => d.objectID || d.id).filter(Boolean);
        const resp = await fetch("https://propr.ro/.netlify/functions/index", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids })
        });

        const data = await resp.json();
        alert(`‚úÖ ${data.message}`);
        loadPosts();
      } catch (err) {
        alert("‚ùå Eroare la »ôtergere: " + err.message);
      }
    }

    function renderPosts(posts) {
      const container = document.getElementById("posts");
      if (!posts.length) {
        container.innerHTML = "<p>Nicio postare salvatƒÉ.</p>";
        return;
      }

      container.innerHTML = posts.map(p => `
        <div class="post">
          <p>${p.text || "(fƒÉrƒÉ text)"}</p>
          <small>
            <b>Autor:</b> ${p.author || "necunoscut"}<br>
            <b>Link:</b> ${p.url ? `<a href="${p.url}" target="_blank">${p.url}</a>` : "‚Äî"}<br>
            <b>Data:</b> ${p.timestamp ? new Date(p.timestamp).toLocaleString() : "‚Äî"}
          </small>
        </div>
      `).join("");
    }

    document.getElementById("search").addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase().trim();
      const filtered = allPosts.filter(p =>
        (p.text && p.text.toLowerCase().includes(q)) ||
        (p.author && p.author.toLowerCase().includes(q)) ||
        (p.url && p.url.toLowerCase().includes(q))
      );
      renderPosts(filtered);
    });

    document.getElementById("deleteDupes").addEventListener("click", deleteDuplicates);

    loadPosts();
  </script>
</body>
</html>
